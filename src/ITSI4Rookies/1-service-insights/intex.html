<p><strong>Table of contents</strong></p>
<ul>
    <li><a href="#1-install-otel-agent">1. Install OTel Agent</a>
        <ul>
            <li><a href="#otel-agent-job-download-하기">OTel Agent Job Download 하기</a></li>
            <li><a href="#job-definition-수정하기">Job Definition 수정하기</a></li>
        </ul>
    </li>
    <li><a href="#2-collect-docker-container-metrics">2. Collect Docker container metrics</a>
        <ul>
            <li><a href="#client-server-에서-nomad-설정-수정">Client Server 에서 nomad 설정 수정</a></li>
            <li><a href="#otel-agentnomad-파일-수정">otel-agent.nomad 파일 수정</a></li>
            <li><a href="#docker-그룹-확인">docker 그룹 확인</a></li>
            <li><a href="#에이전트-재배포-후-수집-확인">에이전트 재배포 후 수집 확인</a></li>
        </ul>
    </li>
    <li><a href="#3-collect-nomad-metrics">3. Collect Nomad metrics</a>
        <ul>
            <li><a href="#client-server-에서-prometheus-메트릭-설정하기">Client Server 에서 prometheus 메트릭 설정하기</a></li>
            <li><a href="#otel-agentnomad-에서-receiver-설정하기">otel-agent.nomad 에서 receiver 설정하기</a></li>
            <li><a href="#에이전트-재배포-후-수집-확인-1">에이전트 재배포 후 수집 확인</a></li>
        </ul>
    </li>
    <li><a href="#4-apm-instrumentation">4. APM Instrumentation</a></li>
</ul>
<h1 id="1-install-otel-agent">1. Install OTel Agent</h1>
<h2 id="otel-agent-job-download-">OTel Agent Job Download 하기</h2>
<p>아래 Github 주소에서 nomad 용 에이전트 job 파일을 다운로드 받습니다.</p>
<p><a href="https://github.com/signalfx/splunk-otel-collector/tree/main/deployments/nomad">Splunk OpenTelemetry
        Collector for HashiCorp Nomad</a></p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>wget <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/signalfx</span><span class="hljs-regexp">/splunk-otel-collector/blob</span><span class="hljs-regexp">/main/deployments</span><span class="hljs-regexp">/nomad/otel</span>-agent.nomad
</code></pre>
<h2 id="job-definition-">Job Definition 수정하기</h2>
<p>다운로드 받은 otel-agent.nomad 파일을 열어 아래 부분을 수정합니다</p>
<pre><code class="lang-bash">job <span class="hljs-string">"otel-agent"</span> {
  <span class="hljs-attr">datacenters</span> = [<span class="hljs-string">"dc1"</span>]
  <span class="hljs-attr">type</span>        = <span class="hljs-string">"system"</span>

<span class="hljs-comment"># Constraint 주석처리</span>
<span class="hljs-comment">#  constraint {</span>
<span class="hljs-comment">#    attribute = "${attr.nomad.version}"</span>
<span class="hljs-comment">#    operator  = "semver"</span>
<span class="hljs-comment">#    value     = "&lt; 1.8.0"</span>
<span class="hljs-comment">#  }</span>

    service {
      <span class="hljs-attr">provider</span> = <span class="hljs-string">"nomad"</span> <span class="hljs-comment">#모든 서비스에 해당 부분 추가</span>
      <span class="hljs-attr">name</span> = <span class="hljs-string">"otel-agent"</span>
      <span class="hljs-attr">port</span> = <span class="hljs-string">"health_check"</span>
      <span class="hljs-attr">tags</span> = [<span class="hljs-string">"health"</span>]


    service {
      <span class="hljs-attr">provider</span> = <span class="hljs-string">"nomad"</span>  <span class="hljs-comment">#모든 서비스에 해당 부분 추가</span>
      <span class="hljs-attr">name</span> = <span class="hljs-string">"otel-agent"</span>
      <span class="hljs-attr">port</span> = <span class="hljs-string">"otlp"</span>
      <span class="hljs-attr">tags</span> = [<span class="hljs-string">"otlp"</span>]
    }


    task <span class="hljs-string">"otel-agent"</span> {


      env {
        <span class="hljs-attr">SPLUNK_ACCESS_TOKEN</span> = <span class="hljs-string">"&lt;o11y_ingest_token&gt;"</span>
        <span class="hljs-attr">SPLUNK_REALM</span> = <span class="hljs-string">"&lt;realm&gt;"</span>
        <span class="hljs-attr">SPLUNK_MEMORY_TOTAL_MIB</span> = <span class="hljs-number">500</span>
      }
    }
</code></pre>
<h1 id="2-collect-docker-container-metrics">2. Collect Docker container metrics</h1>
<p>일단 위 단계에서 수정 한 파일을 가지고 otel agent job을 배포 해 보면 에이전트가 각 클라이언트 서버에 잘 배포 되는 것을 확인 할 수 있습니다.</p>
<pre><code class="lang-bash">$ nomad job run otel-agent.nomad

==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">16</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Monitoring evaluation <span class="hljs-string">"0ccecfc9"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">16</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation triggered by job <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">18</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"38bc5e89"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"c55ca068"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">18</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"e0ace9ab"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"85b7e6e9"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">18</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation status <span class="hljs-string">changed:</span> <span class="hljs-string">"pending"</span> -&gt; <span class="hljs-string">"complete"</span>
==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">43</span>:<span class="hljs-number">18</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation <span class="hljs-string">"0ccecfc9"</span> finished with status <span class="hljs-string">"complete"</span>
</code></pre>
<p>그러나 이 상태에서는 에이전트만 배포되고, 컨테이너에서 발생하는 메트릭을 signalfx로 보내지 못하는 상태입니다. docker receiver 를 설정하여 메트릭을 스크래핑 후 o11y cloud로 보내도록
    설정 해주어야 합니다</p>
<h2 id="client-server-nomad-">Client Server 에서 nomad 설정 수정</h2>
<p>클라이언트 서버에 콘솔로 접근 후, nomad 설정파일을 엽니다</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>cd /etc/nomad.d/
<span class="hljs-variable">$ </span>sudo vi nomad.hcl
</code></pre>
<p>설정 파일에 아래와 같은 형식으로 볼륨 마운트 설정을 넣어줍니다</p>
<pre><code class="lang-bash"><span class="hljs-comment"># nomad.hcl</span>

<span class="hljs-attr">data_dir</span>  = <span class="hljs-string">"/opt/nomad"</span>
<span class="hljs-attr">bind_addr</span> = <span class="hljs-string">"0.0.0.0"</span>

client {
  host_volume <span class="hljs-string">"dockersock"</span> {
    <span class="hljs-attr">path</span>      = <span class="hljs-string">"/var/run/docker.sock"</span>
    <span class="hljs-attr">read_only</span> = <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h2 id="otel-agent-nomad-">otel-agent.nomad 파일 수정</h2>
<p>에이전트 설정 파일에 아래와 같이 내용을 추가합니다</p>
<pre><code class="lang-bash"># otel-agent.nomad

job <span class="hljs-string">"otel-agent"</span> {


  group <span class="hljs-string">"otel-agent"</span> {
    volume <span class="hljs-string">"vol"</span> {
      <span class="hljs-built_in">type</span>      = <span class="hljs-string">"host"</span>
      read_only = true
      <span class="hljs-keyword">source</span>    = <span class="hljs-string">"dockersock"</span>
    }


    task <span class="hljs-string">"otel-agent"</span> {
      driver = <span class="hljs-string">"docker"</span>

      volume_mount {
        volume      = <span class="hljs-string">"vol"</span>
        destination = <span class="hljs-string">"/var/run/docker.sock"</span>
        read_only   = true
      }


receiver<span class="hljs-variable">s:</span>
  smartagent/docker-container-stat<span class="hljs-variable">s:</span>
    <span class="hljs-built_in">type</span>: docker-container-stats


service:
  pipeline<span class="hljs-variable">s:</span>
    metric<span class="hljs-variable">s:</span>
      exporter<span class="hljs-variable">s:</span>
      - <span class="hljs-keyword">debug</span>
      - signalfx
      processor<span class="hljs-variable">s:</span>
      - memory_limiter
      - batch
      - resourcedetection
      receiver<span class="hljs-variable">s:</span>
      - hostmetrics
      - signalfx
      - smartagent/docker-container-stats
</code></pre>
<h2 id="docker-">docker 그룹 확인</h2>
<pre><code class="lang-bash">$ cat /etc/group | grep docker
docker:x:<span class="hljs-number">992</span>:ec2-user

그룹정보를 추가합니다. (group_add)

    task <span class="hljs-string">"otel-agent"</span> {
      <span class="hljs-attr">driver</span> = <span class="hljs-string">"docker"</span>

      volume_mount {
        <span class="hljs-attr">volume</span>      = <span class="hljs-string">"vol"</span>
        <span class="hljs-attr">destination</span> = <span class="hljs-string">"/var/run/docker.sock"</span>
        <span class="hljs-attr">read_only</span>   = <span class="hljs-literal">true</span>
      }

      config {
        <span class="hljs-attr">image</span> = <span class="hljs-string">"quay.io/signalfx/splunk-otel-collector:latest"</span>
        <span class="hljs-attr">group_add</span> = [
          <span class="hljs-string">"992"</span>  <span class="hljs-comment"># 호스트의 docker 그룹 ID</span>
        ]

        <span class="hljs-attr">force_pull</span> = <span class="hljs-literal">true</span>
        <span class="hljs-attr">entrypoint</span> = [
          <span class="hljs-string">"/otelcol"</span>,
          <span class="hljs-string">"--config=local/config/otel-agent-config.yaml"</span>,
          <span class="hljs-string">"--metrics-addr=0.0.0.0:8889"</span>,
        ]
</code></pre>
<h2 id="-">에이전트 재배포 후 수집 확인</h2>
<p>otel-agent.nomad 파일로 잡을 다시 구동시켜 새로운 설정이 에이전트에 반영 되도록 합니다.</p>
<pre><code class="lang-bash">$ nomad job run otel-agent.nomad

==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Monitoring evaluation <span class="hljs-string">"033c1e2e"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation triggered by job <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"fedecf6e"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"85b7e6e9"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"3f403317"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"c55ca068"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation status <span class="hljs-string">changed:</span> <span class="hljs-string">"pending"</span> -&gt; <span class="hljs-string">"complete"</span>
==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation <span class="hljs-string">"033c1e2e"</span> finished with status <span class="hljs-string">"complete"</span>
</code></pre>
<p>Nomad UI 페이지로 가서 job이 제대로 구동되고 있는지 확인합니다.
    <img src="./src/images/2-1-nomad-job-status.jpg" alt="2-1. Nomad Job Status">
</p>
<p>Splunk Observability Cloud 로 가서 컨테이너 메트릭이 유입되고 있는지 확인합니다.
    <img src="./src/images/2-2-o11y-container-dashboard.jpg" alt="2-2. O11y Container Dashboard">
</p>
<h1 id="3-collect-nomad-metrics">3. Collect Nomad metrics</h1>
<p>이제는 노마드 플랫폼에서 제공하는 노마드에 특화된 메트릭을 추가로 수집해야합니다.
    노마드 클러스터를 관리하기 위해서는 리소스를 구분하는 단위가 노마드에서 사용하는 단위 (JOB, Allocation, Server, Client 등) 로 만들어진 메트릭을 가져와야 의미가 있습니다</p>
<h2 id="client-server-prometheus-">Client Server 에서 prometheus 메트릭 설정하기</h2>
<p>제일 처음 해야 될 절차는 노마드 컨테이너를 실행시키는 클라이언트 서버에서 Prometheus metrics를 발생(publish) 시키도록 명시적으로 설정을 해 주어야 합니다.</p>
<p>Nomad Server와 Client들의 /etc/nomad.d/nomad.hcml 에서 아래 내용을 추가 합니다.</p>
<pre><code class="lang-bash">telemetry {
  <span class="hljs-attr">collection_interval</span>        = <span class="hljs-string">"5s"</span>
  <span class="hljs-attr">disable_hostname</span>           = <span class="hljs-literal">false</span>
  <span class="hljs-attr">prometheus_metrics</span>         = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_allocation_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_node_metrics</span>       = <span class="hljs-literal">true</span>
}
</code></pre>
<p>클라이언트 서버로 접속 해 봅시다</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>cd /etc/nomad.d/
<span class="hljs-variable">$ </span>sudo vi nomad.hcl
</code></pre>
<p>설정 파일에 아래와 같은 형식으로 볼륨 마운트 설정을 넣어줍니다</p>
<pre><code class="lang-bash"><span class="hljs-comment"># nomad.hcl</span>

<span class="hljs-comment"># plugin "docker" / config 항목에 allow_privileged = true 을 추가 합니다.</span>
plugin <span class="hljs-string">"docker"</span> {
  config {
    <span class="hljs-attr">endpoint</span> = <span class="hljs-string">"unix:///var/run/docker.sock"</span>
    <span class="hljs-attr">allow_privileged</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 권한 문제 방지</span>
  }
}

<span class="hljs-comment"># 아래 텔레메트리 설정을 Client 바깥에 넣습니다</span>
telemetry {
  <span class="hljs-attr">collection_interval</span>        = <span class="hljs-string">"5s"</span>
  <span class="hljs-attr">disable_hostname</span>           = <span class="hljs-literal">false</span>
  <span class="hljs-attr">prometheus_metrics</span>         = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_allocation_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_node_metrics</span>       = <span class="hljs-literal">true</span>
}
</code></pre>
<p>Nomad Server의 server.hcl</p>
<pre><code class="lang-bash">$ cat /etc/nomad.d/server.hcl

<span class="hljs-attr">datacenter</span> = <span class="hljs-string">"aws"</span>
<span class="hljs-attr">data_dir</span> = <span class="hljs-string">"/opt/nomad"</span>

server {
  <span class="hljs-attr">enabled</span>          = <span class="hljs-literal">true</span>
  <span class="hljs-attr">bootstrap_expect</span> = <span class="hljs-number">1</span>
}

client {
  <span class="hljs-attr">enabled</span> = <span class="hljs-literal">false</span>
}

telemetry {
  <span class="hljs-attr">collection_interval</span> = <span class="hljs-string">"5s"</span>
  <span class="hljs-attr">disable_hostname</span> = <span class="hljs-literal">false</span>
  <span class="hljs-attr">prometheus_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_allocation_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_node_metrics</span>       = <span class="hljs-literal">true</span>
}
</code></pre>
<p>Nomad Client의 client.hcl</p>
<pre><code class="lang-bash">$ cat /etc/nomad.d/client.hcl
<span class="hljs-attr">datacenter</span> = <span class="hljs-string">"aws"</span>
<span class="hljs-attr">data_dir</span> = <span class="hljs-string">"/opt/nomad"</span>

client {
  <span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">servers</span> = [<span class="hljs-string">"172.31.17.214:4647"</span>]

  host_volume <span class="hljs-string">"dockersock"</span> {
    <span class="hljs-attr">path</span>      = <span class="hljs-string">"/var/run/docker.sock"</span>
    <span class="hljs-attr">read_only</span> = <span class="hljs-literal">false</span>
  }
}

plugin <span class="hljs-string">"docker"</span> {
  config {
    <span class="hljs-attr">endpoint</span> = <span class="hljs-string">"unix:///var/run/docker.sock"</span>
    <span class="hljs-attr">allow_privileged</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 권한 문제 방지</span>
  }
}

telemetry {
  <span class="hljs-attr">collection_interval</span> = <span class="hljs-string">"5s"</span>
  <span class="hljs-attr">disable_hostname</span> = <span class="hljs-literal">false</span>
  <span class="hljs-attr">prometheus_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_allocation_metrics</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">publish_node_metrics</span>       = <span class="hljs-literal">true</span>
}
</code></pre>
<p>Nomad Server / Client 들을 각각 재기동합니다.</p>
<pre><code class="lang-bash"><span class="hljs-variable">$ </span>sudo systemctl restart nomad
<span class="hljs-variable">$ </span>sudo systemctl status nomad
</code></pre>
<p>Nomad Server에 환경변수를 설정합니다.</p>
<pre><code class="lang-bash">$ export NOMAD_VAR_host_node_addr=<span class="hljs-variable">$HOSTNAME</span>
$ echo <span class="hljs-variable">$NOMAD_VAR_host_node_addr</span>
ip-<span class="hljs-number">172</span>-<span class="hljs-number">31</span>-<span class="hljs-number">17</span>-<span class="hljs-number">214</span><span class="hljs-selector-class">.ec2</span><span class="hljs-selector-class">.internal</span>
</code></pre>
<p>저는 .bash_profile에 등록하였습니다.</p>
<pre><code class="lang-bash">$ cat .bash_profile
...
<span class="hljs-built_in">export</span> PATH
<span class="hljs-built_in">export</span> NOMAD_VAR_host_node_addr=<span class="hljs-variable">$HOSTNAME</span>
</code></pre>
<h2 id="otel-agent-nomad-receiver-">otel-agent.nomad 에서 receiver 설정하기</h2>
<p>에이전트 파일을 열어서 receivers 아래에 있는 설정에 다음과 같이 추가합니다</p>
<pre><code class="lang-bash">variable <span class="hljs-string">"host_node_addr"</span> {
  <span class="hljs-built_in">type</span> = <span class="hljs-built_in">string</span>
}

job <span class="hljs-string">"otel-agent"</span> {
  datacenters = [<span class="hljs-string">"dc1"</span>]
  <span class="hljs-built_in">type</span>        = <span class="hljs-string">"system"</span>
....

    task <span class="hljs-string">"otel-agent"</span> {
      driver = <span class="hljs-string">"docker"</span>
.....
      env {
        SPLUNK_ACCESS_TOKEN = <span class="hljs-string">"xxxx"</span>
        SPLUNK_REALM = <span class="hljs-string">"lab0"</span>
        SPLUNK_MEMORY_TOTAL_MIB = <span class="hljs-number">500</span>
        HOST_NODE_ADDR = var.host_node_addr
      }
....

receiver<span class="hljs-variable">s:</span>
  prometheus/nomad:
    confi<span class="hljs-variable">g:</span>
      scrape_config<span class="hljs-variable">s:</span>
      - job_name: nomad
        scrape_interva<span class="hljs-variable">l:</span> <span class="hljs-number">10</span>s
        metrics_path: /v1/metrics
        param<span class="hljs-variable">s:</span>
          forma<span class="hljs-variable">t:</span> [<span class="hljs-string">'prometheus'</span>]
        static_config<span class="hljs-variable">s:</span>
        - target<span class="hljs-variable">s:</span>
          - ${HOST_NODE_ADDR}:<span class="hljs-number">4646</span>

processor<span class="hljs-variable">s:</span>
  resourcedetection/<span class="hljs-keyword">o</span><span class="hljs-variable">s:</span>
    detector<span class="hljs-variable">s:</span>
      - <span class="hljs-built_in">system</span>
    <span class="hljs-built_in">system</span>:
      hostname_source<span class="hljs-variable">s:</span>
        - os

service:
  pipeline<span class="hljs-variable">s:</span>
    metric<span class="hljs-variable">s:</span>
      exporter<span class="hljs-variable">s:</span>
      - <span class="hljs-keyword">debug</span>
      - signalfx
      processor<span class="hljs-variable">s:</span>
      - memory_limiter
      - batch
      - resourcedetection
      - resourcedetection/os
      receiver<span class="hljs-variable">s:</span>
      - hostmetrics
      - signalfx
      - smartagent/docker-container-stats
      - prometheus/nomad
</code></pre>
<h2 id="-">에이전트 재배포 후 수집 확인</h2>
<p>otel-agent.nomad 파일로 잡을 다시 구동시켜 새로운 설정이 에이전트에 반영 되도록 합니다.</p>
<pre><code class="lang-bash">$ nomad job run otel-agent.nomad

==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Monitoring evaluation <span class="hljs-string">"033c1e2e"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation triggered by job <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"fedecf6e"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"85b7e6e9"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Allocation <span class="hljs-string">"3f403317"</span> <span class="hljs-string">created:</span> node <span class="hljs-string">"c55ca068"</span>, group <span class="hljs-string">"otel-agent"</span>
    <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation status <span class="hljs-string">changed:</span> <span class="hljs-string">"pending"</span> -&gt; <span class="hljs-string">"complete"</span>
==&gt; <span class="hljs-number">2025</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span><span class="hljs-string">T09:</span><span class="hljs-number">45</span>:<span class="hljs-number">30</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>: Evaluation <span class="hljs-string">"033c1e2e"</span> finished with status <span class="hljs-string">"complete"</span>
</code></pre>
<p>Running 상태의 Allication ID 확인하고, 아래 명령으로 Node server host가 출력되는지 확인합니다.</p>
<pre><code class="lang-bash">$ <span class="hljs-keyword">node</span> <span class="hljs-title">job</span> status otel-agent

$ <span class="hljs-keyword">node</span> <span class="hljs-title">alloc</span> exec <span class="hljs-tag">&lt;alloc_id&gt;</span> sh

$ echo $HOST_NODE_ADDR
</code></pre>
<p>Nomad UI 페이지로 가서 job이 제대로 구동되고 있는지 확인합니다.
    <img src="./src/images/2-1-nomad-job-status.jpg" alt="2-1. Nomad Job Status">
</p>
<p>Splunk Observability Cloud 로 가서 노마드 메트릭이 유입되고 있는지 확인합니다.
    <img src="./src/images/3-1-o11y-nomad-metrics.jpg" alt="2-2. O11y Container Dashboard">
</p>
<h1 id="4-apm-instrumentation">4. APM Instrumentation</h1>
<p>작성 예정</p>